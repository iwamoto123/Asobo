# fastlane/Fastfile
# .p8鍵ファイルを直接読み込んで、ビルド→TestFlightへアップロードする最小レーン

default_platform(:ios)

platform :ios do
 before_all do
  issuer = "70fd2f6e-2a07-4623-b675-aa38c12d75f9"   

  key_path = File.expand_path(File.join(__dir__, "AuthKey_B54L5B26YC.p8"))
  UI.user_error!("API key file not found: #{key_path}") unless File.exist?(key_path)

  @api_key = app_store_connect_api_key(
    key_id:     "B54L5B26YC",
    issuer_id:  issuer,
    key_content: File.read(key_path),
    in_house:   false
  )
end


  desc "Build and upload to TestFlight"
  lane :beta do

    increment_build_number(xcodeproj: "Asobo.xcodeproj")# ← 自動で+1
    
    clean_build_artifacts

    # CocoaPods を使っていない（.xcodeproj直）の場合
    build_app(
      scheme: "Asobo",                # ← XcodeのScheme名に合わせる
      export_method: "app-store",
      output_directory: "build",
      skip_profile_detection: true,
      destination: "generic/platform=iOS",
      sdk: "iphoneos",  
      # project: "Asobo.xcodeproj",   # （必要なら明示。workspaceとどちらか片方のみ）
      # workspace: "Asobo.xcworkspace" # CocoaPods使用時はこっちを有効化して、project行は消す

      export_options: {
      signingStyle: "automatic"   # Xcodeの自動サインを使う
      },
      xcargs: "-allowProvisioningUpdates"  # 書き出し時にプロファイル/証明書を自動取得
    )

    upload_to_testflight(
      api_key: @api_key,
      skip_waiting_for_build_processing: true,  # App Store側の処理待ちをスキップ
      notify_external_testers: false            # 外部テスターへの通知はオフ（必要ならtrue）
    )
  end

  # 任意：ビルドだけ試すとき用（アップロードしない）
  desc "Build only (no upload)"
  lane :build_only do
    clean_build_artifacts
    build_app(
      scheme: "Asobo",
      export_method: "app-store",
      output_directory: "build",
      skip_profile_detection: true
    )
  end
end
