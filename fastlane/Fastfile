# fastlane/Fastfile
# .p8éµãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç›´æ¥èª­ã¿è¾¼ã‚“ã§ã€ãƒ“ãƒ«ãƒ‰â†’TestFlightã¸ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹æœ€å°ãƒ¬ãƒ¼ãƒ³

require 'fileutils'
require 'tmpdir'

default_platform(:ios)

platform :ios do
 before_all do
  issuer = "70fd2f6e-2a07-4623-b675-aa38c12d75f9"   
 
  key_path = File.expand_path(File.join(__dir__, "AuthKey_B54L5B26YC.p8"))
  UI.user_error!("API key file not found: #{key_path}") unless File.exist?(key_path)
 
  @api_key = app_store_connect_api_key(
    key_id:     "B54L5B26YC",
    issuer_id:  issuer,
    key_content: File.read(key_path),
    in_house:   false
  )
  
  # âœ… altoolãŒ.p8ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¢ã™å ´æ‰€ã«ã‚·ãƒ³ãƒœãƒªãƒƒã‚¯ãƒªãƒ³ã‚¯ã‚’ä½œæˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
  # altoolã¯ä»¥ä¸‹ã®å ´æ‰€ã‚’æ¢ã—ã¾ã™ï¼š
  # - ~/workspace/Asobo/private_keys
  # - ~/private_keys
  # - ~/.private_keys
  # - ~/.appstoreconnect/private_keys
  # altool_key_dir = File.expand_path("~/.appstoreconnect/private_keys")
  # unless File.directory?(altool_key_dir)
  #   FileUtils.mkdir_p(altool_key_dir)
  # end
  # altool_key_path = File.join(altool_key_dir, "AuthKey_B54L5B26YC.p8")
  # unless File.exist?(altool_key_path)
  #   FileUtils.cp(key_path, altool_key_path)
  #   UI.message("âœ… .p8ãƒ•ã‚¡ã‚¤ãƒ«ã‚’altoolç”¨ã®å ´æ‰€ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ: #{altool_key_path}")
  # end
  # 
  # âœ… App Store Connect APIã‚’å¼·åˆ¶çš„ã«ä½¿ç”¨ï¼ˆaltoolã‚’ç„¡åŠ¹åŒ–ï¼‰
  # ENV["FASTLANE_APPLE_APPLICATION_SPECIFIC_PASSWORD"] = ""
  # ENV["FASTLANE_USER"] = ""
end


  desc "Build and upload to TestFlight"
  lane :beta do

    increment_build_number(xcodeproj: "Asobo.xcodeproj")# â† è‡ªå‹•ã§+1
    
    clean_build_artifacts

    # ã¾ãšã¯ xcarchive ã¾ã§ä½œã‚‹ï¼ˆIPAåŒ–ã®å‰ã«ã€onnxruntime.framework ã‚’ãƒ‘ãƒƒãƒã™ã‚‹ãŸã‚ï¼‰
    archive_path = File.expand_path("build/Asobo.xcarchive")

    # CocoaPods ã‚’ä½¿ã£ã¦ã„ãªã„ï¼ˆ.xcodeprojç›´ï¼‰ã®å ´åˆ
    build_app(
      scheme: "Asobo",                # â† Xcodeã®Schemeåã«åˆã‚ã›ã‚‹
      export_method: "app-store",
      output_directory: "build",
      skip_profile_detection: true,
      destination: "generic/platform=iOS",
      sdk: "iphoneos",  
      archive_path: archive_path,
      skip_package_ipa: true,
      skip_package_pkg: true,
      # project: "Asobo.xcodeproj",   # ï¼ˆå¿…è¦ãªã‚‰æ˜ç¤ºã€‚workspaceã¨ã©ã¡ã‚‰ã‹ç‰‡æ–¹ã®ã¿ï¼‰
      # workspace: "Asobo.xcworkspace" # CocoaPodsä½¿ç”¨æ™‚ã¯ã“ã£ã¡ã‚’æœ‰åŠ¹åŒ–ã—ã¦ã€projectè¡Œã¯æ¶ˆã™

      export_options: {
      signingStyle: "automatic"   # Xcodeã®è‡ªå‹•ã‚µã‚¤ãƒ³ã‚’ä½¿ã†
      },
      xcargs: "-allowProvisioningUpdates"  # æ›¸ãå‡ºã—æ™‚ã«ãƒ—ãƒ­ãƒ•ã‚¡ã‚¤ãƒ«/è¨¼æ˜æ›¸ã‚’è‡ªå‹•å–å¾—
    )

    # build_app ãŒ archive_path ã‚’åˆ¥ãƒ‘ã‚¹ã«ã—ãŸå ´åˆã«å‚™ãˆã¦ lane context ã‹ã‚‰ã‚‚æ‹¾ã†
    begin
      if defined?(SharedValues) && SharedValues.const_defined?(:XCODEBUILD_ARCHIVE)
        ctx_archive = Actions.lane_context[SharedValues::XCODEBUILD_ARCHIVE]
        archive_path = ctx_archive if ctx_archive && !ctx_archive.to_s.empty?
      end
    rescue
      # ignore
    end

    UI.user_error!("âŒ xcarchive ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: #{archive_path}") unless File.directory?(archive_path)

    # âœ… xcarchive å†…ã® onnxruntime.framework ã« MinimumOSVersion ã‚’åŸ‹ã‚è¾¼ã‚€ï¼ˆApp Store Connect å¯¾ç­–ï¼‰
    onnx_plist = File.join(
      archive_path,
      "Products/Applications/Asobo.app/Frameworks/onnxruntime.framework/Info.plist"
    )

    UI.message("ğŸ”§ Patching onnxruntime.framework Info.plist in archive: #{onnx_plist}")
    UI.user_error!("âŒ onnxruntime.framework Info.plist ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: #{onnx_plist}") unless File.exist?(onnx_plist)

    # IPHONEOS_DEPLOYMENT_TARGET ã‚’ãã®ã¾ã¾ä½¿ã†ï¼ˆç©ºãªã‚‰ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå´ã®å€¤ã«åˆã‚ã›ã¦è¦èª¿æ•´ï¼‰
    min_os = ENV["IPHONEOS_DEPLOYMENT_TARGET"]
    min_os = "18.5" if min_os.to_s.empty?

    sh("/usr/libexec/PlistBuddy -c \"Add :MinimumOSVersion string #{min_os}\" \"#{onnx_plist}\" 2>/dev/null || /usr/libexec/PlistBuddy -c \"Set :MinimumOSVersion #{min_os}\" \"#{onnx_plist}\"")
    UI.message("âœ… onnxruntime.framework MinimumOSVersion => #{min_os}")

    # âœ… ã“ã“ã‹ã‚‰ IPA ã‚’æ›¸ãå‡ºã™ï¼ˆexportArchive ãŒå†ç½²åã™ã‚‹ã®ã§ã€plistç·¨é›†å¾Œã§ã‚‚æ•´åˆã™ã‚‹ï¼‰
    export_plist = File.join(Dir.mktmpdir, "exportOptions.plist")
    File.write(export_plist, <<~PLIST)
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
        <key>method</key>
        <string>app-store</string>
        <key>signingStyle</key>
        <string>automatic</string>
      </dict>
      </plist>
    PLIST

    ipa_output_dir = File.expand_path("build")
    FileUtils.mkdir_p(ipa_output_dir)

    sh("xcodebuild -exportArchive -archivePath \"#{archive_path}\" -exportPath \"#{ipa_output_dir}\" -exportOptionsPlist \"#{export_plist}\" -allowProvisioningUpdates")

    ipa_path = File.join(ipa_output_dir, "Asobo.ipa")

    # âœ… IPAãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
    if ipa_path && File.exist?(ipa_path)
      UI.message("âœ… IPAãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèª: #{ipa_path}")
      UI.message("   ã‚µã‚¤ã‚º: #{File.size(ipa_path)} bytes")
    else
      # ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®ãƒ‘ã‚¹ã‚’ç¢ºèª
      default_ipa_path = File.expand_path("build/Asobo.ipa")
      if File.exist?(default_ipa_path)
        ipa_path = default_ipa_path
        UI.message("âœ… IPAãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆãƒ‘ã‚¹ï¼‰: #{ipa_path}")
      else
        UI.user_error!("âŒ IPAãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ“ãƒ«ãƒ‰ãŒå¤±æ•—ã—ãŸå¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚")
      end
    end

    begin
      # âœ… App Store Connect APIã‚’å¼·åˆ¶çš„ã«ä½¿ç”¨ï¼ˆaltoolã®ä»£ã‚ã‚Šï¼‰
      upload_to_testflight(
        api_key: @api_key,
        skip_waiting_for_build_processing: true,  # App Storeå´ã®å‡¦ç†å¾…ã¡ã‚’ã‚¹ã‚­ãƒƒãƒ—
        notify_external_testers: false,            # å¤–éƒ¨ãƒ†ã‚¹ã‚¿ãƒ¼ã¸ã®é€šçŸ¥ã¯ã‚ªãƒ•ï¼ˆå¿…è¦ãªã‚‰trueï¼‰
        verbose: true,                             # è©³ç´°ãƒ­ã‚°ã‚’æœ‰åŠ¹åŒ–
        skip_submission: false,                    # æå‡ºã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ãªã„
        distribute_external: false,                # å¤–éƒ¨é…å¸ƒã¯ã—ãªã„
        ipa: ipa_path                              # build_appãŒç”Ÿæˆã—ãŸIPAãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹ã‚’ä½¿ç”¨
      )
    rescue => ex
      UI.error("TestFlightã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã‚¨ãƒ©ãƒ¼: #{ex.message}")
      UI.error("ã‚¨ãƒ©ãƒ¼ã‚¯ãƒ©ã‚¹: #{ex.class}")
      
      # âœ… ã‚ˆã‚Šè©³ç´°ãªã‚¨ãƒ©ãƒ¼æƒ…å ±ã‚’å–å¾—
      if ex.respond_to?(:cause) && ex.cause
        UI.error("åŸå› : #{ex.cause.message}")
        UI.error("åŸå› ã‚¯ãƒ©ã‚¹: #{ex.cause.class}")
      end
      
      # âœ… IPAãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèªï¼ˆã‚¨ãƒ©ãƒ¼æ™‚ï¼‰
      if ipa_path && File.exist?(ipa_path)
        UI.message("âœ… IPAãƒ•ã‚¡ã‚¤ãƒ«ã¯å­˜åœ¨ã—ã¾ã™: #{ipa_path}")
        UI.message("   ã‚µã‚¤ã‚º: #{File.size(ipa_path)} bytes")
      else
        UI.error("âŒ IPAãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: #{ipa_path || 'nil'}")
      end
      
      UI.error("ãƒãƒƒã‚¯ãƒˆãƒ¬ãƒ¼ã‚¹:")
      UI.error(ex.backtrace.join("\n"))
      raise
    end
  end

  # ä»»æ„ï¼šãƒ“ãƒ«ãƒ‰ã ã‘è©¦ã™ã¨ãç”¨ï¼ˆã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãªã„ï¼‰
  desc "Build only (no upload)"
  lane :build_only do
    clean_build_artifacts
    build_app(
      scheme: "Asobo",
      export_method: "app-store",
      output_directory: "build",
      skip_profile_detection: true
    )
  end
end
